#!/bin/sh

remove_if_exists()
{
    if [ -e "$1" ] && ! rm -rf "$1"
    then
        exit 1
    fi
}

echo_me()
{
    echo "$ME: $*"
}

prepare()
{
    remove_if_exists "$BUILD/scroom-$VERSION"
    remove_if_exists "$BUILD/scroom_$VERSION.orig.tar.gz"
    remove_if_exists "debuild.log"
    remove_if_exists "config.log"
    remove_if_exists "configure.log"
    remove_if_exists "lucid.log"
    remove_if_exists "maverick.log"
    remove_if_exists "mutracx.log"
    remove_if_exists "pdebuild.log"
}

ME="$0"
PACKAGE_NAME="@PACKAGE_NAME@"
PACKAGE_TARNAME="@PACKAGE_TARNAME@"
PACKAGE_VERSION="@PACKAGE_VERSION@"
PACKAGE_STRING="@PACKAGE_STRING@"
PACKAGE_BUGREPORT="@PACKAGE_BUGREPORT@"
PACKAGE_URL="@PACKAGE_URL@"
PACKAGE="@PACKAGE@"
VERSION="@VERSION@"

# echo_me "Hello world"
# echo_me "TMPDIR:    $TMPDIR"
# echo_me "TMPSRCDIR: $TMPSRCDIR"
# echo_me "SOURCE:    $SOURCE"
# echo_me "BUILD:     $BUILD"

# Asserts...
[ -d "$TMPSRCDIR" ] || exit 1
[ -f "$SOURCE" -a -r "$SOURCE" ] || exit 1
[ -d "$BUILD" -a -w "$BUILD" ] || exit 1


if [ "$PACKAGE" != "scroom" ]
then
    echo_me "ERROR: $SOURCE doesn't contain scroom!"
    exit 1
fi
if [ -e "$TMPSRCDIR/debian" ]
then
    echo_me "ERROR: $TMPSRCDIR/debian exists"
    exit 1
fi

SNAPSHOT=0
RELEASECANDIDATE=0
case "$VERSION" in
    *-*)
        SNAPSHOT=1;
        ;;
    *~*)
        RELEASECANDIDATE=1;
        ;;
esac

echo_me "Preparing build environment"
prepare
cp -pr "$TMPSRCDIR" "$BUILD/scroom-$VERSION" || exit 1
cp "$SOURCE" "$BUILD/scroom_$VERSION.orig.tar.gz" || exit 1
cp -r ./debian "$BUILD/scroom-$VERSION/debian" || exit 1

CURDIR="$(pwd)"
cd  "$BUILD/scroom-$VERSION" || exit 1

# Todo: build package ;-)
if [ "$SNAPSHOT" -eq "1" ]
then
    dch -d "Snapshot release"
elif [ "$RELEASECANDIDATE" -eq "1" ]
then
    VER=$(echo "$VERSION" | cut -d'~' -f1) && \
        dch -d "Release candidate for version $VER" && \
        dch -a "For more info see http://fuzzy.homedns.org/trac/scroom/milestone/$VER"
else
    dch -d "For more info see http://fuzzy.homedns.org/trac/scroom/milestone/$VERSION"
fi || exit 1

echo_me "Creating a tar file for package flavors"
tar czfC "$TMPDIR/scroom-$VERSION-base.tgz" "$BUILD" "scroom-$VERSION"

echo_me "Building"
if ! ( make distclean && debuild -us -uc -j12 ) > "$CURDIR/debuild.log" 2>&1
then
    echo_me "ERROR: debuild failed. See debuild.log"
    exit 1
fi
echo_me "Base version done. Trying pdebuild"
if ! ( sudo pdebuild -- --debbuildopts -j12 ) > $CURDIR/pdebuild.log 2>&1
then
    echo_me "ERROR: pdebuild failed. See pdebuild.log"
fi

cd "$CURDIR" || exit 1
cp "$BUILD/scroom-$VERSION/debian/changelog" ./debian/changelog || exit 1

# Ubuntu source packages
for source_package in lucid maverick
do
    echo_me $source_package
    ( rm -rf "$BUILD/$source_package" > /dev/null 2>&1 ;
        mkdir -p "$BUILD/$source_package" && 
        ln "$BUILD/scroom_$VERSION.orig.tar.gz" "$BUILD/$source_package/scroom_$VERSION.orig.tar.gz" && 
        tar xfC "$TMPDIR/scroom-$VERSION-base.tgz" "$BUILD/$source_package" && 
        cd "$BUILD/$source_package/scroom-$VERSION" &&
        if [ -d "$CURDIR/${source_package}-patches" ]
        then
            QUILT_PATCHES="$CURDIR/${source_package}-patches" quilt push -a
        else
            true
        fi &&
        dch -D "$source_package" -v "$(dpkg-parsechangelog | awk '/^Version: / { print $2 }')${source_package}1" \
            "$source_package edition" && 
        debuild -S -sa -us -uc -j12
        ) > ${source_package}.log 2>&1
done

# Mutracx
echo_me "Mutracx"
source_package=mutracx
(
    rm -rf "$BUILD/$source_package" > /dev/null 2>&1 ;    
    mkdir -p "$BUILD/$source_package" && 
    ln "$BUILD/scroom_$VERSION.orig.tar.gz" "$BUILD/$source_package/scroom_$VERSION.orig.tar.gz" && 
    tar xfC "$TMPDIR/scroom-$VERSION-base.tgz" "$BUILD/$source_package" && 
    cd "$BUILD/$source_package/scroom-$VERSION" && 
    QUILT_PATCHES="$CURDIR/${source_package}-patches" quilt push -a &&
    VER="$(dpkg-parsechangelog | awk '/^Version: / { print $2 }')${source_package}1" &&
    dch -D "hardy" -v "$VER" "Mutracx edition" && 
    sudo DIST=mutracx ARCH=amd64 pdebuild --debbuildopts "-j12 -sa" && 
    sudo DIST=mutracx ARCH=i386  pdebuild --debbuildopts "-j12 -B"
    ) > ${source_package}.log 2>&1

#     debuild -S -sa -us -uc &&
#     sudo DIST=mutracx ARCH=amd64 pbuilder build "$BUILD/$source_package/scroom_${VER}.dsc" && 
#     sudo DIST=mutracx ARCH=i386  pbuilder build "$BUILD/$source_package/scroom_${VER}.dsc"
# echo_me "Bye world"
