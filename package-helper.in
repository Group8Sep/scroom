#!/bin/sh

remove_if_exists()
{
    if [ -e "$1" ] && ! rm -rf "$1"
    then
        exit 1
    fi
}

echo_me()
{
    echo "$ME: $*"
}

prepare()
{
    remove_if_exists "$BUILD/scroom-$VERSION"
    remove_if_exists "$BUILD/scroom_$VERSION.orig.tar.gz"
    remove_if_exists "debuild.log"
}

ME="$0"
PACKAGE_NAME="@PACKAGE_NAME@"
PACKAGE_TARNAME="@PACKAGE_TARNAME@"
PACKAGE_VERSION="@PACKAGE_VERSION@"
PACKAGE_STRING="@PACKAGE_STRING@"
PACKAGE_BUGREPORT="@PACKAGE_BUGREPORT@"
PACKAGE_URL="@PACKAGE_URL@"
PACKAGE="@PACKAGE@"
VERSION="@VERSION@"

# echo_me "Hello world"
# echo_me "TMPSRCDIR: $TMPSRCDIR"
# echo_me "SOURCE:    $SOURCE"
# echo_me "BUILD:     $BUILD"

# Asserts...
[ -d "$TMPSRCDIR" ] || exit 1
[ -f "$SOURCE" -a -r "$SOURCE" ] || exit 1
[ -d "$BUILD" -a -w "$BUILD" ] || exit 1


if [ "$PACKAGE" != "scroom" ]
then
    echo_me "ERROR: $SOURCE doesn't contain scroom!"
    exit 1
fi
if [ -e "$TMPSRCDIR/debian" ]
then
    echo_me "ERROR: $TMPSRCDIR/debian exists"
    exit 1
fi

SNAPSHOT=0
RELEASECANDIDATE=0
case "$VERSION" in
    *-*)
        SNAPSHOT=1;
        ;;
    *~*)
        RELEASECANDIDATE=1;
        ;;
esac

echo_me "Preparing build environment"
prepare
cp -pr "$TMPSRCDIR" "$BUILD/scroom-$VERSION" || exit 1
cp "$SOURCE" "$BUILD/scroom_$VERSION.orig.tar.gz" || exit 1
cp -r ./debian "$BUILD/scroom-$VERSION/debian" || exit 1

CURDIR="$(pwd)"
cd  "$BUILD/scroom-$VERSION" || exit 1

# Todo: build package ;-)
if [ "$SNAPSHOT" -eq "1" ]
then
    dch -d "Snapshot release"
elif [ "$RELEASECANDIDATE" -eq "1" ]
then
    VER=$(echo "$VERSION" | cut -d'~' -f1) && \
        dch -d "Release candidate for version $VER" && \
        dch -a "For more info see http://fuzzy.homedns.org/trac/scroom/milestone/$VER"
else
    dch -d "For more info see http://fuzzy.homedns.org/trac/scroom/milestone/$VERSION"
fi || exit 1

if ! ( make distclean && debuild -us -uc ) > "$CURDIR/debuild.log" 2>&1
then
    echo_me "ERROR: debuild failed. See debuild.log"
    exit 1
fi

cd "$CURDIR" || exit 1
cp "$BUILD/scroom-$VERSION/debian/changelog" ./debian/changelog || exit 1

# echo_me "Bye world"
